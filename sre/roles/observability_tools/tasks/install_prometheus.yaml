---
- name: Copy alerting rules template into tmp directory for processing
  ansible.builtin.copy:
    src: templates/prometheus-alerting-rules.j2
    dest: /tmp/prometheus-alerting-rules.j2
    mode: "0644"

- name: Create a temporary template with fake curly brackets for processing
  ansible.builtin.replace:
    path: /tmp/prometheus-alerting-rules.j2
    regexp: "\\{\\{([a-zA-Z\\.$_ ]*)\\}\\}"
    replace: "<<\\1>>"

- name: Create new alerting rules template from proccesed template
  ansible.builtin.copy:
    dest: /tmp/prometheus-required-alerting-rules.j2
    content: "{{ lookup('ansible.builtin.template', '/tmp/prometheus-alerting-rules.j2') }}"
    mode: "0644"

- name: Escape double curly brackets in alerting rules yaml file
  ansible.builtin.replace:
    path: /tmp/prometheus-required-alerting-rules.j2
    regexp: "<<([a-zA-Z\\.$_ ]*)>>"
    replace: "\\{\\{\"\\{\\{\"\\}\\}\\1\\{\\{\"\\}\\}\"\\}\\}"

- name: Remove double backslash in alerting rules yaml file
  ansible.builtin.replace:
    path: /tmp/prometheus-required-alerting-rules.j2
    regexp: "\\\\"
    replace: ""

- name: Install Prometheus Operator and Prometheus
  kubernetes.core.helm:
    chart_ref: kube-prometheus-stack
    chart_repo_url: https://prometheus-community.github.io/helm-charts
    chart_version: 72.3.0
    kubeconfig: "{{ observability_tools_cluster.kubeconfig }}"
    release_name: "{{ helm_release.name }}"
    release_namespace: "{{ helm_release.namespace }}"
    release_state: present
    timeout: 10m0s
    values:
      # additionalPrometheusRulesMap:
      #   "incident-alerts": "{{ lookup('ansible.builtin.template', '/tmp/prometheus-required-alerting-rules.j2') | from_yaml }}"
      #   "incident-rules": "{{ lookup('ansible.builtin.template', 'templates/prometheus-recording-rules.j2') | from_yaml }}"
      grafana:
        enabled: false
      prometheus:
        prometheusSpec:
          ruleNamespaceSelector:
            matchLabels:
              it-bench/monitoring: "true"
          ruleSelectorNilUsesHelmValues: false
          serviceMonitorNamespaceSelector:
            matchLabels:
              it-bench/monitoring: "true"
          serviceMonitorSelectorNilUsesHelmValues: false
    wait: true
  when:
    - observability_tools_cluster.platform == "kubernetes"

- name: Enable OpenShift user workload monitoring
  kubernetes.core.k8s:
    kubeconfig: "{{ observability_tools_cluster.kubeconfig }}"
    state: present
    src: files/ocp/user-workload-monitoring-config.yaml
  when:
    - observability_tools_cluster.platform == "openshift"

- name: Wait for Prometheus workload pods to start
  kubernetes.core.k8s_info:
    kind: Pod
    kubeconfig: "{{ observability_tools_cluster.kubeconfig }}"
    label_selectors:
      - app.kubernetes.io/component = prometheus
      - app.kubernetes.io/instance = user-workload
    namespace: openshift-user-workload-monitoring
    wait: true
    wait_condition:
      type: Ready
      status: "True"
    wait_timeout: 300
  when:
    - observability_tools_cluster.platform == "openshift"

- name: Create Prometheus Rules for workloads
  kubernetes.core.k8s:
    kubeconfig: "{{ observability_tools_cluster.kubeconfig }}"
    namespace: "{{ helm_release.namespace }}"
    state: present
    src: files/rules/workload.yaml

- name: Create Prometheus Rules for cluster
  kubernetes.core.k8s:
    kubeconfig: "{{ observability_tools_cluster.kubeconfig }}"
    namespace: "{{ helm_release.namespace }}"
    state: present
    src: files/rules/cluster.yaml
